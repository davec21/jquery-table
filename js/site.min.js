/*!
 * Start Bootstrap - Agency v3.3.7+1 (http://startbootstrap.com/template-overviews/agency)
 * Copyright 2013-2017 Start Bootstrap
 * Licensed under MIT (https://github.com/BlackrockDigital/startbootstrap/blob/gh-pages/LICENSE)
 */
function showTable(t){createForm(t),createTable(t),$("tbody").sortable({update:function(e,a){rowDropped(t,a.item.startPos,a.item.index())},start:function(t,e){e.item.startPos=e.item.index()}}),$(".modal").on("hidden.bs.modal",function(e){fillTableRows(t,tableId)}),presentTableModal()}function init(t){$.ajax({type:"get",url:t,dataType:"json",success:function(t){console.log("Data fetched successfully. Begin parse.",t),showTable(t)}})}function makeElement(t,e,a,n,d){var l=document.createElement(t);l.className=a;var o,r;if(n){o=Object.keys(n);for(var r=0;r<o.length;r++)l.setAttribute(o[r],n[o[r]])}if(d){o=Object.keys(d);for(var r=0;r<o.length;r++)l.addEventListener(o[r],d[o[r]])}return l.innerHTML=e,l}function createModal(t,e,a,n){var d="mdl-"+$(".modal").length;console.log("Generating modal with ID:",d);var l=document.createElement("div");l.setAttribute("id",d),l.setAttribute("class","modal fade"),l.setAttribute("tabindex","-1"),l.setAttribute("data-keyboard","false"),l.setAttribute("role","dialog"),l.setAttribute("aria-labelledby","myModalLabel");var o=document.createElement("div");o.setAttribute("class","modal-dialog"),o.setAttribute("role","document"),l.appendChild(o);var r=document.createElement("div");r.setAttribute("class","modal-content"),o.appendChild(r);var i=document.createElement("div");i.setAttribute("class","modal-header"),i.innerHTML='<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="myModalLabel">'+e+"</h4></div>",r.appendChild(i);var c=document.createElement("div");c.setAttribute("class","modal-body"),r.appendChild(c);var s=document.createElement("div");s.setAttribute("class","modal-footer");var u=[makeElement("button","Close","btn btn-default",{"data-dismiss":"modal"},{click:function(){previousRow(t)}})];a&&(u=[makeElement("button","Previous Row","btn btn-primary",null,{click:function(){previousRow(t)}})].concat(u)),n&&u.push(makeElement("button","Next Row","btn btn-primary",null,{click:function(){nextRow(t)}})),s.innerHTML="";for(var b=0;b<u.length;b++)s.append(u[b]);return r.appendChild(s),l}function createForm(t){var e=createModal(t,"Edit Row",!0,!0);detailModalId=e.getAttribute("id");var a=$(e).find(".modal-body");a.html("");for(var n=0;n<t.columns.length;n++){var d=document.createElement("div");d.setAttribute("class","form-group"),$(d).html('<label for="exampleInputEmail1">'+t.columns[n].name+"</label>");var l=createInput(t,n,0);l.setAttribute("class","form-control"),l.setAttribute("id",detailModalId+"-dval-"+n),d.appendChild(l),a.append(d)}$(".content").append(e)}function createTable(data){var tableModal=createModal(data,"View Data",!1,!1);tableModalId=tableModal.getAttribute("id");var modalBody=$(tableModal).find(".modal-body"),tableContainer=document.createElement("div");tableContainer.setAttribute("class","container table-wrapper");var btn=document.createElement("button");btn.className="btn btn-small btn-success",btn.addEventListener("click",function(){addNewRow(data)}),btn.innerHTML="Add Row",tableContainer.append(btn),tableId="tbl-"+$("table").length,console.log("Generating table with ID:",tableId);var table=document.createElement("table");table.setAttribute("id",tableId);var header=document.createElement("thead");table.appendChild(header);var body=document.createElement("tbody");table.appendChild(body);var headerRow=document.createElement("tr");header.appendChild(headerRow);var numCol=document.createElement("th");numCol.setAttribute("class","dark"),headerRow.appendChild(numCol),data.columns.forEach(function(column){var cache={};column.validationFunc?eval("cache.validationFunc = "+column.validationFunc):"json"===column.datatype&&(cache.validationFunc=validateJsonInput),column._cache=cache;var col=document.createElement("th");col.setAttribute("class","dark"),col.innerHTML=column.name,headerRow.appendChild(col)}),tableContainer.appendChild(table),modalBody.html(tableContainer),$(".content").append(tableModal),fillTableRows(data)}function fillTableRows(t){var e=$("#"+tableId+" > tbody");e.html("");for(var a=0;a<t.data.length;a++){var n=document.createElement("tr");n.setAttribute("id","row-"+a);var d=document.createElement("td");d.setAttribute("class","dark"),$(d).html(a+1),n.appendChild(d);for(var l=0;l<t.columns.length;l++){var o=document.createElement("td");o.appendChild(createInput(t,l,a)),n.appendChild(o)}e.append(n)}}function createInput(t,e,a){var n=t.columns[e],d=t.data[a],l=d[e];l||(l="");var o;if(n.input){if("select"===n.input.type){var r=n.input.data.values,i=n.input.data.displays;o=document.createElement("select"),o.addEventListener("change",function(){endEdit(t,o)});for(var c=0;c<r.length;c++){var s=document.createElement("option");s.setAttribute("value",r[c]),r[c]===l&&s.setAttribute("selected","true"),$(s).html(i[c]),o.appendChild(s)}}}else{switch(o=document.createElement("input"),o.addEventListener("dblclick",function(){editRow(t,a)}),o.addEventListener("blur",function(){endEdit(t,o)}),n.datatype){case"string":o.setAttribute("type","text");break;case"json":""!==l&&(l=JSON.stringify(l)),o.setAttribute("type","text");break;case"number":o.setAttribute("type","number");break;case"date":o.setAttribute("type","date")}o.setAttribute("value",l)}return o.setAttribute("class","bound-value"),o.setAttribute("data-col",e),o.setAttribute("data-row",a),o.setAttribute("data-old",l),o.addEventListener("dblclick",function(){editRow(t,a)}),o.addEventListener("keydown",function(e){"Escape"===e.key?cancelEdit(e.target):"Delete"===e.key&&($(e.target).blur(),deleteRow(t,$(e.target).attr("data-row")))}),o.setAttribute("tabIndex",e+1+a*t.columns.length),o}function addNewRow(t){t.hasInvalidField||(t.data.push(new Array(t.columns.length)),fillTableRows(t))}function deleteRow(t,e){t.data.splice(e,1),fillTableRows(t)}function editRow(t,e){editRowId=e;for(var a=t.columns,n=0;n<a.length;n++){var d=t.data[e][n];""!=d&&"json"===a[n].datatype&&(d=JSON.stringify(d));var l=$("#"+detailModalId+"-dval-"+n);l.val(d),l.attr("data-col",n),l.attr("data-row",e),l.attr("data-old",d)}$("#"+detailModalId).css("z-index","9000").modal("show")}function endEdit(t,e){var a=$(e);if(a){var n=a.attr("data-col"),d=a.attr("data-row"),l=t.columns[n],o=a.attr("data-old"),r=a.val();if(o!==r&&!validateInput(r,l))return a.css("border","2px solid red"),a.focus(),void(t.hasInvalidField=!0);"json"===l.datatype&&r.length>0&&(r=JSON.parse(r)),a.css("border",""),t.data[d][n]=r,a.attr("data-old",r),t.hasInvalidField=!1}}function cancelEdit(t){var e=$(t);e.val(e.attr("data-old"))}function nextRow(t){if(!t.hasInvalidField){var e=editRowId+1;e>=t.data.length&&(e=t.data.length-1),editRow(t,e)}}function previousRow(t){if(!t.hasInvalidField){var e=editRowId-1;e<0&&(e=0),editRow(t,e)}}function validateInput(t,e){return!e._cache.validationFunc||e._cache.validationFunc(t)}function validateJsonInput(t){if(!t)return!1;try{JSON.parse(t);return!0}catch(e){return console.log(e),!1}}function rowDropped(t,e,a){if(e!==a){var n=t.data[e];t.data.splice(e,1),t.data.splice(a,0,n),fillTableRows(t)}}function presentTableModal(){$("#"+tableModalId).modal("show")}var editRowId=0,currTabIndex=0,tableId="",tableModalId="",detailModalId="";
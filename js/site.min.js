/*!
 * Start Bootstrap - Agency v3.3.7+1 (http://startbootstrap.com/template-overviews/agency)
 * Copyright 2013-2017 Start Bootstrap
 * Licensed under MIT (https://github.com/BlackrockDigital/startbootstrap/blob/gh-pages/LICENSE)
 */
function init(t){"use strict";var e={hasInvalidField:!1,tabIndex:0,rows:[],columns:[],deletedRows:[]};$.ajax({type:"get",url:t,dataType:"json",success:function(n){console.log("Data fetched from url: "+t+" successfully. Begin parse.",n),e.rows=n.data,e.columns=n.columns,showTable(e)}})}function showTable(t){createForm(t),createTable(t),$("tbody").sortable({connectWith:"#delete",stop:function(e,n){n.item["delete"]?$("tbody").sortable("cancel"):rowDropped(t,n.item.startPos,n.item.index())},start:function(t,e){e.item.startPos=e.item.index()}}),$("#delete").sortable({receive:function(e,n){n.item["delete"]=!0,deleteRow(t,n.item)},revert:!0,cancel:".ui-state-disabled"}),$(".modal").on("hidden.bs.modal",function(e){fillTableRows(t)}),presentTableModal(t)}function save(t){if(!t.hasInvalidField){for(var e={columns:t.columns,data:[]},n=0;n<t.rows.length;n++)t.rows[n].deleted||e.data.push(t.rows[n]);console.log(e,t)}}function makeElement(t,e,n,a,r){var o=document.createElement(t);o.className=n;var l,d;if(a)for(l=Object.keys(a),d=0;d<l.length;d++)o.setAttribute(l[d],a[l[d]]);if(r)for(l=Object.keys(r),d=0;d<l.length;d++)o.addEventListener(l[d],r[l[d]]);return o.innerHTML=e,o}function createModal(t,e,n,a,r){var o="mdl-"+$(".modal").length;console.log("Generating modal with ID:",o);var l=document.createElement("div");l.setAttribute("id",o),l.setAttribute("class","modal fade"),l.setAttribute("tabindex","-1"),l.setAttribute("data-keyboard","false"),l.setAttribute("role","dialog"),l.setAttribute("aria-labelledby","myModalLabel");var d=document.createElement("div");d.setAttribute("class","modal-dialog"),d.setAttribute("role","document"),l.appendChild(d);var c=document.createElement("div");c.setAttribute("class","modal-content"),d.appendChild(c);var i=document.createElement("div");i.setAttribute("class","modal-header"),i.innerHTML='<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="myModalLabel">'+e+"</h4></div>",c.appendChild(i);var s=document.createElement("div");s.setAttribute("class","modal-body"),c.appendChild(s);var u=document.createElement("div");u.setAttribute("class","modal-footer");var b=[makeElement("button","Close","btn btn-default",{"data-dismiss":"modal"})];n&&(b=[makeElement("button","Previous Row","btn btn-primary",null,{click:function(){previousRow(t)}})].concat(b)),r&&b.push(makeElement("button","Delete Row","btn btn-danger",null,{click:function(){deleteRow(t),nextRow(t)}})),a&&b.push(makeElement("button","Next Row","btn btn-primary",null,{click:function(){nextRow(t)}})),u.innerHTML="";for(var m=0;m<b.length;m++)u.append(b[m]);return c.appendChild(u),l}function createForm(t){var e=createModal(t,"Edit Row",!0,!0,!0);t.detailModalId=e.getAttribute("id");var n=$(e).find(".modal-body");n.html("");for(var a=0;a<t.columns.length;a++){var r=document.createElement("div");r.setAttribute("class","form-group"),$(r).html('<label for="exampleInputEmail1">'+t.columns[a].name+"</label>");var o=createInput(t,a,null);o.addEventListener("change",function(e){endEdit(t)}),o.setAttribute("class","form-control"),o.setAttribute("id",t.detailModalId+"-dval-"+a),r.appendChild(o),n.append(r)}$(".content").append(e)}function createTable(ctx){var tableModal=createModal(ctx,"View Data",!1,!1,!1);ctx.tableModalId=tableModal.getAttribute("id");var modalBody=$(tableModal).find(".modal-body"),tableContainer=document.createElement("div");tableContainer.setAttribute("class","container table-wrapper");var btn=document.createElement("button");btn.className="btn btn-small btn-success",btn.addEventListener("click",function(){addNewRow(ctx)}),btn.innerHTML="Add Row",tableContainer.append(btn);var btn=document.createElement("button");btn.className="btn btn-small btn-primary",btn.addEventListener("click",function(){save(ctx)}),btn.innerHTML="Submit",tableContainer.append(btn);var deleteIcon=document.createElement("button");deleteIcon.className="btn btn-small btn-danger",deleteIcon.id="delete",deleteIcon.innerHTML='<span class="glyphicon glyphicon-trash ui-state-disabled"></span> Drop to Delete',tableContainer.append(deleteIcon),ctx.tableId="tbl-"+$("table").length,console.log("Generating table with ID:",ctx.tableId);var table=document.createElement("table");table.setAttribute("id",ctx.tableId);var header=document.createElement("thead");table.appendChild(header);var body=document.createElement("tbody");body.addEventListener("dblclick",function(t){ctx.currentRow=$(t.target.closest("tr")),ctx.currentRow.id=ctx.currentRow.attr("_row_id"),editRow(ctx)}),body.addEventListener("change",function(t){endEdit(ctx,t.target)}),body.addEventListener("blur",function(){endEdit(ctx,event.target)}),body.addEventListener("keydown",function(t){"Escape"===t.key&&cancelEdit(t.target)}),table.appendChild(body);var headerRow=document.createElement("tr");header.appendChild(headerRow);var numCol=document.createElement("th");numCol.setAttribute("class","dark"),headerRow.appendChild(numCol),ctx.columns.forEach(function(column){var cache={};column.validationFunc?eval("cache.validationFunc = "+column.validationFunc):"json"===column.datatype&&(cache.validationFunc=validateJsonInput),column._cache=cache;var col=document.createElement("th");col.setAttribute("class","dark"),col.innerHTML=column.name,headerRow.appendChild(col)}),tableContainer.appendChild(table),modalBody.html(tableContainer),$(".content").append(tableModal),fillTableRows(ctx)}function fillTableRows(t){var e=$("#"+t.tableId+" > tbody");e.html("");for(var n,a=0;a<t.rows.length;a++){var r=document.createElement("tr");r.setAttribute("_row_id",a),t.rows[a].deleted&&r.setAttribute("style","display:none");var n=document.createElement("td");n.setAttribute("class","dark"),$(n).html(a+1),r.appendChild(n);for(var o=0;o<t.columns.length;o++)n=document.createElement("td"),n.appendChild(createInput(t,o,t.rows[a][o])),r.appendChild(n);e.append(r)}}function createInput(t,e,n){var a,r=t.columns[e];if(r.input){if("select"===r.input.type){var o=r.input.data.values,l=r.input.data.displays;a=document.createElement("select");for(var d=0;d<o.length;d++){var c=document.createElement("option");c.setAttribute("value",o[d]),o[d]===n&&c.setAttribute("selected","true"),$(c).html(l[d]),a.appendChild(c)}}}else{switch(a=document.createElement("input"),r.datatype){case"number":case"date":a.setAttribute("type",r.datatype);break;case"string":case"json":a.setAttribute("type","text"),"json"==r.datatype&&n&&n.constructor!=String&&(n=JSON.stringify(n))}null!=n&&void 0!=n&&a.setAttribute("value",n)}return a.setAttribute("class","bound-value"),a.setAttribute("data-old",n),a.setAttribute("tabIndex",t.tabIndex++),a.setAttribute("_colIndex",e),a}function addNewRow(t){t.hasInvalidField||(t.rows.push(new Array(t.columns.length)),fillTableRows(t))}function null_or_first(t){return t&&t.constructor==Array&&t.length>0?$(t[0]):t?$(t):null}function deleteRow(t,e){e&&(t.currentRow=null_or_first(e.closest("tr")),t.currentRow.id=t.currentRow.attr("_row_id")),t.currentRow.css("display","None");var n=+t.currentRow.attr("_row_id");t.rows[n].deleted=!0,t.deletedRows.unshift(n);for(var a=n;a<t.rows.length+1;a++);}function editRow(t){for(var e=t.columns,n=0;n<e.length;n++){var a=t.rows[t.currentRow.attr("_row_id")][n];"json"===e[n].datatype&&a&&a.constructor!=String&&(a=JSON.stringify(a));var r=$("#"+t.detailModalId+"-dval-"+n);null!=a&&void 0!=a&&r.val(a),r.attr("data-old",a)}$("#"+t.detailModalId).css("z-index","9000").modal("show")}function endEdit(t,e){e&&(t.currentInput=null_or_first(e.closest("input")),t.currentRow=null_or_first(e.closest("tr")),t.currentRow.id=t.currentRow.attr("_row_id"));var n=t.currentInput;if(!n)return t.hasInvalidField=!1,!0;var a=parseInt(n.attr("_colIndex")),r=t.columns[a],o=n.attr("data-old"),l=n.val();return o===l||validateInput(l,r)?("json"===r.datatype&&l.length>0&&(l=JSON.parse(l)),n.css("border",""),t.rows[t.currentRow.attr("_row_id")][a]=l,n.attr("data-old",l),void(t.hasInvalidField=!1)):(n.css("border","2px solid red"),n.focus(),void(t.hasInvalidField=!0))}function cancelEdit(t){var e=$(t);e.val(e.attr("data-old"))}function nextRow(t){if(!t.hasInvalidField&&t.currentRow&&t.currentRow.next()){t.currentRow;t.currentRow=$(t.currentRow.next()),t.currentRow.id=t.currentRow.attr("_row_id"),t.rows[t.currentRow.id].deleted?nextRow(t):editRow(t)}}function previousRow(t){t.hasInvalidField||t.currentRow&&t.currentRow.prev()&&(t.currentRow=t.currentRow.prev(),t.currentRow.id=t.currentRow.attr("_row_id"),t.rows[t.currentRow.id].deleted?previousRow(t):editRow(t))}function validateInput(t,e){return!e._cache.validationFunc||e._cache.validationFunc(t)}function validateJsonInput(t){if(!t)return!1;try{JSON.parse(t);return!0}catch(e){return console.log(e),!1}}function rowDropped(t,e,n){if(e!==n){var a=t.rows[e];t.rows.splice(e,1),t.rows.splice(n,0,a),fillTableRows(t)}}function presentTableModal(t){$("#"+t.tableModalId).modal("show")}
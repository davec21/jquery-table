/*!
 * Start Bootstrap - Agency v3.3.7+1 (http://startbootstrap.com/template-overviews/agency)
 * Copyright 2013-2017 Start Bootstrap
 * Licensed under MIT (https://github.com/BlackrockDigital/startbootstrap/blob/gh-pages/LICENSE)
 */
function showTable(e){createForm(e),createTable(e),$("tbody").sortable({connectWith:"#delete",update:function(t,a){rowDropped(e,a.item.startPos,a.item.index())},start:function(e,t){t.item.startPos=t.item.index()}}),$("#delete").sortable({update:function(t,a){deleteRow(e,a.item.startPos),a.item.remove()},cancel:".ui-state-disabled"}),$(".modal").on("hidden.bs.modal",function(t){fillTableRows(e,tableId)}),presentTableModal()}function init(e){$.ajax({type:"get",url:e,dataType:"json",success:function(e){console.log("Data fetched successfully. Begin parse.",e),showTable(e)}})}function save(e){e.hasInvalidField||console.log(e)}function makeElement(e,t,a,n,d){var l=document.createElement(e);l.className=a;var o,i;if(n){o=Object.keys(n);for(var i=0;i<o.length;i++)l.setAttribute(o[i],n[o[i]])}if(d){o=Object.keys(d);for(var i=0;i<o.length;i++)l.addEventListener(o[i],d[o[i]])}return l.innerHTML=t,l}function createModal(e,t,a,n,d){var l="mdl-"+$(".modal").length;console.log("Generating modal with ID:",l);var o=document.createElement("div");o.setAttribute("id",l),o.setAttribute("class","modal fade"),o.setAttribute("tabindex","-1"),o.setAttribute("data-keyboard","false"),o.setAttribute("role","dialog"),o.setAttribute("aria-labelledby","myModalLabel");var i=document.createElement("div");i.setAttribute("class","modal-dialog"),i.setAttribute("role","document"),o.appendChild(i);var r=document.createElement("div");r.setAttribute("class","modal-content"),i.appendChild(r);var c=document.createElement("div");c.setAttribute("class","modal-header"),c.innerHTML='<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="myModalLabel">'+t+"</h4></div>",r.appendChild(c);var s=document.createElement("div");s.setAttribute("class","modal-body"),r.appendChild(s);var u=document.createElement("div");u.setAttribute("class","modal-footer");var b=[makeElement("button","Close","btn btn-default",{"data-dismiss":"modal"},{click:function(){previousRow(e)}})];a&&(b=[makeElement("button","Previous Row","btn btn-primary",null,{click:function(){previousRow(e)}})].concat(b)),d&&b.push(makeElement("button","Delete Row","btn btn-danger",null,{click:function(){deleteRow(e,editRowId),nextRow(e)}})),n&&b.push(makeElement("button","Next Row","btn btn-primary",null,{click:function(){nextRow(e)}})),u.innerHTML="";for(var m=0;m<b.length;m++)u.append(b[m]);return r.appendChild(u),o}function createForm(e){var t=createModal(e,"Edit Row",!0,!0,!0);detailModalId=t.getAttribute("id");var a=$(t).find(".modal-body");a.html("");for(var n=0;n<e.columns.length;n++){var d=document.createElement("div");d.setAttribute("class","form-group"),$(d).html('<label for="exampleInputEmail1">'+e.columns[n].name+"</label>");var l=createInput(e,n,-1);l.setAttribute("class","form-control"),l.setAttribute("id",detailModalId+"-dval-"+n),d.appendChild(l),a.append(d)}$(".content").append(t)}function createTable(data){var tableModal=createModal(data,"View Data",!1,!1,!1);tableModalId=tableModal.getAttribute("id");var modalBody=$(tableModal).find(".modal-body"),tableContainer=document.createElement("div");tableContainer.setAttribute("class","container table-wrapper");var btn=document.createElement("button");btn.className="btn btn-small btn-success",btn.addEventListener("click",function(){addNewRow(data)}),btn.innerHTML="Add Row",tableContainer.append(btn);var btn=document.createElement("button");btn.className="btn btn-small btn-primary",btn.addEventListener("click",function(){save(data)}),btn.innerHTML="Submit",tableContainer.append(btn);var deleteIcon=document.createElement("button");deleteIcon.className="btn btn-small btn-danger",deleteIcon.id="delete",deleteIcon.innerHTML='<span class="glyphicon glyphicon-trash ui-state-disabled"></span> Drop to Delete',tableContainer.append(deleteIcon),tableId="tbl-"+$("table").length,console.log("Generating table with ID:",tableId);var table=document.createElement("table");table.setAttribute("id",tableId);var header=document.createElement("thead");table.appendChild(header);var body=document.createElement("tbody");table.appendChild(body);var headerRow=document.createElement("tr");header.appendChild(headerRow);var numCol=document.createElement("th");numCol.setAttribute("class","dark"),headerRow.appendChild(numCol),data.columns.forEach(function(column){var cache={};column.validationFunc?eval("cache.validationFunc = "+column.validationFunc):"json"===column.datatype&&(cache.validationFunc=validateJsonInput),column._cache=cache;var col=document.createElement("th");col.setAttribute("class","dark"),col.innerHTML=column.name,headerRow.appendChild(col)}),tableContainer.appendChild(table),modalBody.html(tableContainer),$(".content").append(tableModal),fillTableRows(data)}function fillTableRows(e){var t=$("#"+tableId+" > tbody");t.html("");for(var a=0;a<e.data.length;a++){var n=document.createElement("tr");n.setAttribute("id","row-"+a);var d=document.createElement("td");d.setAttribute("class","dark"),$(d).html(a+1),n.appendChild(d);for(var l=0;l<e.columns.length;l++){var o=document.createElement("td");o.appendChild(createInput(e,l,a)),n.appendChild(o)}t.append(n)}}function createInput(e,t,a){var n=e.columns[t],d=e.data[a>0?a:0],l=d[t];l||(l="");var o;if(n.input){if("select"===n.input.type){var i=n.input.data.values,r=n.input.data.displays;o=document.createElement("select"),o.addEventListener("change",function(){endEdit(e,a,o)});for(var c=0;c<i.length;c++){var s=document.createElement("option");s.setAttribute("value",i[c]),i[c]===l&&s.setAttribute("selected","true"),$(s).html(r[c]),o.appendChild(s)}}}else{switch(o=document.createElement("input"),o.addEventListener("dblclick",function(){editRow(e,a)}),o.addEventListener("blur",function(){endEdit(e,a,o)}),n.datatype){case"string":o.setAttribute("type","text");break;case"json":""!==l&&(l=JSON.stringify(l)),o.setAttribute("type","text");break;case"number":o.setAttribute("type","number");break;case"date":o.setAttribute("type","date")}o.setAttribute("value",l)}return o.setAttribute("class","bound-value"),o.setAttribute("data-col",t),o.setAttribute("data-old",l),o.addEventListener("dblclick",function(){editRow(e,a)}),o.addEventListener("keydown",function(t){"Escape"===t.key?cancelEdit(t.target):"Delete"===t.key&&($(t.target).blur(),deleteRow(e,a))}),o.setAttribute("tabIndex",t+1+a*e.columns.length),o}function addNewRow(e){e.hasInvalidField||(e.data.push(new Array(e.columns.length)),fillTableRows(e))}function deleteRow(e,t){e.data.splice(t,1),$("#row-"+t).remove();for(var a=t+1;a<=e.data.length;a++){var n=$("#row-"+a);n.find(".dark").text(a);n.attr("id","row-"+(a-1))}}function editRow(e,t){editRowId=t;for(var a=e.columns,n=0;n<a.length;n++){var d=e.data[t][n];""!=d&&"json"===a[n].datatype&&(d=JSON.stringify(d));var l=$("#"+detailModalId+"-dval-"+n);l.val(d),l.attr("data-col",n),l.attr("data-old",d)}$("#"+detailModalId).css("z-index","9000").modal("show")}function endEdit(e,t,a){var n=$(a);if(n){t===-1&&(t=editRowId);var d=n.attr("data-col"),l=e.columns[d],o=n.attr("data-old"),i=n.val();if(o!==i&&!validateInput(i,l))return n.css("border","2px solid red"),n.focus(),void(e.hasInvalidField=!0);"json"===l.datatype&&i.length>0&&(i=JSON.parse(i)),n.css("border",""),e.data[t][d]=i,n.attr("data-old",i),e.hasInvalidField=!1}}function cancelEdit(e){var t=$(e);t.val(t.attr("data-old"))}function nextRow(e){if(!e.hasInvalidField){var t=editRowId+1;t>=e.data.length&&(t=e.data.length-1),t>=0?editRow(e,t):$("#"+detailModalId).modal("hide")}}function previousRow(e){if(!e.hasInvalidField){var t=editRowId-1;t<0&&(t=0),editRow(e,t)}}function validateInput(e,t){return!t._cache.validationFunc||t._cache.validationFunc(e)}function validateJsonInput(e){if(!e)return!1;try{JSON.parse(e);return!0}catch(t){return console.log(t),!1}}function rowDropped(e,t,a){if(t!==a){var n=e.data[t];e.data.splice(t,1),e.data.splice(a,0,n),fillTableRows(e)}}function presentTableModal(){$("#"+tableModalId).modal("show")}var editRowId=0,currTabIndex=0,tableId="",tableModalId="",detailModalId="";